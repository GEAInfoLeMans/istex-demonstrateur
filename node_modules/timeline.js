function truncate(str, maxLength, suffix) {
	if(str.length > maxLength) {
		str = str.substring(0, maxLength + 1); 
		str = str.substring(0, Math.min(str.length, str.lastIndexOf(" ")));
		str = str + suffix;
	}
	return str;
}

function mouseover(p) {
	var g = d3.select(this).node().parentNode;
	d3.select(g).selectAll("circle").style("display","none");
	d3.select(g).selectAll("text.value").style("display","block");
}

function mouseout(p) {
	var g = d3.select(this).node().parentNode;
	d3.select(g).selectAll("circle").style("display","block");
	d3.select(g).selectAll("text.value").style("display","none");
}

var d3 = require('d3'), 
jsdom = require('jsdom'),
logger=require('logger'),
controller =require('controller')
dataviz='<div id="dataviz-container"></div>';

//---------------------/timeline---------------------------------------------------
//---------------------/timeline---------------------------------------------------
//---------------------/timeline---------------------------------------------------

module.exports={
	//800, 650, 1970, 2013, 20
	chart : function(var_data,var_width, var_height, var_max, var_margin, res) {
		jsdom.env(
				dataviz,
				function(errors, window) {
					var margin = {top: var_margin*2, right: var_margin*6, bottom: var_margin, left: var_margin},
						width = var_width,
						height = var_height;

					var c = d3.scale.category20c();

					function truncator(numToTruncate, intDecimalPlaces) {    
					    var numPower = Math.pow(10, intDecimalPlaces); // "numPowerConverter" might be better
					    return ~~(numToTruncate * numPower)/numPower;
					}

					domain=[1,3];
					var x = d3.scale.linear().range([0, width]).domain(domain);

					var xAxis = d3.svg.axis().scale(x).orient("top").ticks(3).tickValues([1,2,3]);
					var xScale = d3.scale.linear().range([0, width]).domain(domain);
					//var formatYears = d3.format("0000");
					//xAxis.tickFormat(formatYears);

					var el = window.document.querySelector('#dataviz-container');

					var svg = d3.select(el).append("svg")
						//.attr("width", width + margin.left + margin.right)
						//.attr("height", height + margin.top + margin.bottom)
						.attr("preserveAspectRatio", "xMinYMin meet")
						 .attr("viewBox", "0 0 "+(width+margin.right)+" "+height)
						.style("margin-left", margin.left + "px")
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


					svg.append("g")
						.attr("class", "x axis")
						.call(xAxis);
					svg.selectAll("text").text(function(d) {return "P"+d});

					data=var_data;
					for (var j = 0; j < data.length; j++) {
						var g = svg.append("g").attr("class","journal");

						var circles = g.selectAll("circle")
							.data(data[j]['frequency'])
							.enter()
							.append("circle");

						var text = g.selectAll("text")
							.data(data[j]['frequency'])
							.enter()
							.append("text");

						var rScale = d3.scale.linear()
							.domain([0, var_max])
							.range([1, 15]);


						circles
							.attr("cx", function(d, i) { return xScale(d[0].substring(1,2)); })
							.attr("cy", j*30+40)
							.attr("r", function(d) { return rScale(Math.round(d[1])); })
							.style("fill", function(d) { return c(j); });

						text
							.attr("y", j*30+40)
							.attr("x",function(d, i) { return xScale(d[0].substring(1,2))-5; })
							.attr("class","value")
							.style("font-size", "12px")
							.text(function(d){ return truncator(d[1],2); })
							.style("fill", function(d) { return c(j); })
							.style("display","none");

						g.append("text")
							.attr("y", j*30+40)
							.attr("x",width+50)
							.style("font-size", "12px")
							.attr("class","label")
							.text(truncate(data[j]['name'],50,"..."))
							.style("fill", function(d) { return c(j); })
							.on("mouseover", mouseover)
							.on("mouseout", mouseout);
					}
					var svgsrc = window.document.querySelector('#dataviz-container').innerHTML;
						controller.timeline(res, svgsrc);
			}
		)
	}
}


