var d3 = require('d3'), 
jsdom = require('jsdom'),
logger=require('logger'),
controller =require('controller')
dataviz='<div id="dataviz-container"></div>';


module.exports={
	chart : function(var_data,var_width,res) {
			jsdom.env(
				dataviz,
				function(errors, window) {
					for (i in var_data) {
						data=var_data[i];
					
					var diameter = var_width,
				    format = d3.format(",d");

					var pack = d3.layout.pack()
					    .size([diameter - 4, diameter - 4])
					    .value(function(d) { return d.size; });

					var el = window.document.querySelector('#dataviz-container')

					var svg = d3.select(el).append("svg")
					    .attr("preserveAspectRatio", "xMinYMin meet")
						 .attr("viewBox", "0 0 "+(diameter*3)+" "+diameter)
					  .append("g")
					    .attr("transform", "translate(2,2)");

					root=data;
					var node = svg.datum(root).selectAll(".node")
					  .data(pack.nodes)
					.enter().append("g")
					  .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
					  .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

					node.append("title")
					  .text(function(d) { return d.name + (d.children ? "" : ": " + format(d.size)); });

					node.append("circle")
					  .attr("r", function(d) { return d.r; })
					  .style("opacity", "0.3");

					node.append("text")
					  .attr("dy", function(d) { return d.children ? ".0em" : ".3em"; })
					  .style("font-size", function(d) { return d.children ? "22px" : "16px"; })
					  .style("text-anchor", "middle")
					  .text(function(d) { return d.name; });


					//d3.select(self.frameElement).style("height", diameter + "px");
				}

					var svgsrc = window.document.querySelector('#dataviz-container').innerHTML;
					controller.embeddedCircle(res, svgsrc);
			}
			);
	}
	
}