var d3 = require('d3'), 
jsdom = require('jsdom'),
logger=require('logger'),
colorer= require("colorbrewer"),
controller =require('controller'),
dataviz='<div id="dataviz-container"></div>';

module.exports={
    chart: function(objectResult,dataset, width, height,paddingTop, paddingTopLegend, res){
	    jsdom.env(
			dataviz,
			function(errors, window) {
				var el = window.document.querySelector('#dataviz-container');

				var color = d3.scale.quantile().range(d3.range(6));
				domain=[]
				for (i in dataset) domain.push(dataset[i].frequency);
				color.domain(domain);
				color_list=colorer.brewer.RdYlGn[9];
				if (color_list[8] != '#d73027')
					color_list=color_list.reverse();
				color.range(color_list);

				svg = d3.select(el).append("svg")
			        .attr("preserveAspectRatio", "xMinYMin meet")
						 .attr("viewBox", "0 0 "+width+" "+height);
			    svg.selectAll("rect")
				   .data(dataset)
				   .enter()
				   .append("rect")
				   .attr("x", function(d, i) {
					    return i * ( width / dataset.length);
					})
				   .attr("y", paddingTop*1.8)
				   .attr("width", width / dataset.length - 2)
				   .attr("height", function(d) {
					    return d.frequency * 10;
					})
				   .style("fill", function (d) {
				    	return color(d.frequency);
					});

				function wrap( d ) {
	                var self = d3.select(this),
	                	limit=13,
	                    textLength = self.text().length,
	                    original=self.text().length,
	                    text = self.text();
	                while ( ( textLength > limit )&& text.length > 0) {
	                    text = text.slice(0, -1);
	                    self.text(text);
	                    textLength = self.text().length;
	                }
	                if (original > limit)
	                    	self.text(self.text() + '...');

	            }
				svg.selectAll("text").data(dataset).enter()
					.append("text")
				    .attr("x", function(d, i) {
					    return i * ( width / dataset.length) + width / dataset.length /2;
					})
				    .attr("y", paddingTopLegend+15)
				    .style("text-anchor", "middle")
	            	.style("font-size", "10px")
	            	.style("writing-mode", "tb")
	            	.style("font-family", "sans-serif")
	            	.attr("title", function (d) {
				    	return d.object;
					})
	            	.attr("class", "object")
				    .text(function (d) {
				    	return d.object;
					})
					.each( wrap );

				svg.selectAll(".frequency").data(dataset).enter()
					.append("text")
				    .attr("x", function(d, i) {
					    return i * ( width / dataset.length) + width / dataset.length /2;
					})
					.attr("class", "frequency")
				    .attr("y", function(d) {
					    return  paddingTopLegend + (paddingTop * 1.6) +d.frequency*10;
					})
				    .style("text-anchor", "middle")
	            	.style("font-size", "10px")
	            	.style("font-family", "sans-serif")
				    .text(function (d) {
				    	return d.frequency;
					});

				objectResult.svgsrc = window.document.querySelector('#dataviz-container').innerHTML;
				controller.barchart(res, objectResult);
			}
		)
	}
}	
