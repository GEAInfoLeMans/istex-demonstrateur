var d3 = require('d3'), 
jsdom = require('jsdom'),
logger=require('logger'),
controller =require('controller'),
dataviz='<div id="dataviz-container"></div>';

module.exports={
    chart: function(objectResult,clustersSrc,clustersTarget, clustersAppeared, clustersVanished, width, height,margin,padding, res){
        jsdom.env(
            	dataviz,
            	function(errors, window) {
                    var el = window.document.querySelector('#dataviz-container');

                    var svg = d3.select(el).append("svg")
                                .attr("preserveAspectRatio", "xMinYMin meet")
                         .attr("viewBox", "0 0 "+width+" "+height).style("padding","10px");

                    var normalize=function(value) {
                        return Math.pow(value, 0.6);
                    }

                    //---------------------------------------------------------------------------Feeding src and target lists
                    SrcList=[];
                    for (key in clustersSrc) {
                        SrcList.push(clustersSrc[key]);
                    }
                    TargetList=[];
                    for (key in clustersTarget) {
                        TargetList.push(clustersTarget[key]);
                    }

                    //---------------------------------------------------------------------------Fixing parameters
                    var srcHeightClusterMax=0;
                    var targetHeightClusterMax=0;

                    var sizeClsSrc= ((width - 2 * margin) - (padding*(SrcList.length + clustersVanished.length))) / (SrcList.length + clustersVanished.length);
                    logger.debug(sizeClsSrc);
                    var sizeClsTarget= ((width - 2 * margin) - (padding*(TargetList.length + clustersAppeared.length))) / (TargetList.length + clustersAppeared.length);
                    var relativeHeightSrc=height/4;
                    var relativeHeightTarget=3*height /4;
                    var colors=d3.scale.category10();

                    //---------------------------------------------------------------------------Getting max radius for src and target
                    for (key in clustersSrc) {
                        height_tmp = clustersSrc[key].target.length*10+padding;
                        if (height_tmp  > srcHeightClusterMax)
                            srcHeightClusterMax=height_tmp;
                    }
                    for (key in clustersTarget) {
                        height_tmp = clustersTarget[key].src.length*10+padding;
                        if (height_tmp  > targetHeightClusterMax)
                            targetHeightClusterMax=height_tmp;
                    }

                    //---------------------------------------------------------------------------Drawing Rectangles
                    svg.append("rect")
                        .attr("y",function(d){return relativeHeightSrc - srcHeightClusterMax -margin /2;})
                        .attr("x",function(d,i){return margin-padding;})
                        .attr("rx","1")
                        .attr("ry","1")
                        .attr("class","SrcList")
                        .attr("width",((SrcList.length+clustersVanished.length)*sizeClsSrc)+margin)
                        .attr("height",srcHeightClusterMax+ 2*margin);
                    svg.append("rect")
                        .attr("y",function(d){return relativeHeightTarget - targetHeightClusterMax -margin /2;})
                        .attr("x",function(d,i){return margin-padding;})
                        .attr("rx","1")
                        .attr("class","TargetList")
                        .attr("ry","1")
                        .attr("width",(TargetList.length + clustersAppeared.length)*sizeClsTarget+margin)
                        .attr("height",targetHeightClusterMax + 2*margin);

                    logger.debug("Drawing sources"); //----------------------------------------Drawing Cluster sources
                    svg.selectAll("circle").data(SrcList).enter().append("circle")
                    .attr("cy",function(d){d.y = relativeHeightSrc; return d.y;})
                    .attr("cx",function(d,i){d.x = (i*sizeClsSrc)+2*margin; return d.x;})
                    .attr("r",function(d){ 
                        return normalize(d.size);
                    })
                    .attr("class","ClusterSource")
                    .attr("period", objectResult.psrc)
                    .attr("title",function(d){return d.name.replace(/\s/g, '');});

                    svg.selectAll(".vanished").data(clustersVanished).enter().append("circle")
                    .attr("cy",function(d){d.y = relativeHeightSrc; return d.y;})
                    .attr("cx",function(d,i){d.x = ((i + SrcList.length)*sizeClsSrc)+2*margin; return d.x;})
                    .attr("r",function(d){ 
                        return normalize(d.size);
                    })
                    .attr("period", objectResult.psrc)
                    .attr("state","vanished")
                    .attr("class","ClusterSource")
                    .attr("title",function(d){return d.name.replace(/\s/g, '');});
                    logger.debug("End drawing sources");


                    logger.debug("Drawing targets");//----------------------------------------Drawing Cluster targets
                    svg.selectAll(".target").data(TargetList).enter().append("circle")
                    .attr("cy",function(d){d.y = relativeHeightTarget; return d.y;})
                    .attr("cx",function(d,i){d.x = (i*sizeClsTarget)+2*margin; return d.x;})
                    .attr("class", "ClusterTarget")
                    .attr("title",function(d){return d.name.replace(/\s/g, '');})
                    .attr("period", objectResult.ptgt)
                    .attr("r",function(d){
                        return normalize(d.size);
                    });
                    svg.selectAll(".appeared").data(clustersAppeared).enter().append("circle")
                    .attr("cy",function(d){d.y = relativeHeightTarget; return d.y;})
                    .attr("cx",function(d,i){d.x = ((i + TargetList.length)*sizeClsTarget)+2*margin; return d.x;})
                    .attr("period", objectResult.ptgt)
                    .attr("state", "appeared")
                    .attr("class", "ClusterTarget")
                    .attr("title",function(d){return d.name.replace(/\s/g, '');})
                    .attr("r",function(d){
                        return normalize(d.size);
                    });

                    

                    //---------------------------------------------------------------------------Adding the Cluster labels
                    logger.debug("Drawing labels");
                    var labels = svg.selectAll("text");
                    labels.data(SrcList).enter().append("text")
                    .text(function(d){return d.name;})
                    .style("font-size", "18px")
                    .attr("class", "Cluster")
                    .attr("period", objectResult.psrc)
                    .attr("y",relativeHeightSrc)
                    .attr("x",function(d,i){return (i*sizeClsSrc)+2*margin+5;});

                    labels.data(clustersVanished).enter().append("text")
                    .text(function(d){return d.name;})
                    .style("font-size", "18px")
                    .attr("class", "Cluster")
                    .attr("period", objectResult.psrc)
                    .attr("y",relativeHeightSrc)
                    .attr("x",function(d,i){return ((i+SrcList.length)*sizeClsSrc)+2*margin+5;});
                    labels.data(TargetList).enter().append("text")
                    .text(function(d){return d.name;})
                    .style("font-size", "18px")
                    .attr("class", "Cluster")
                    .attr("period", objectResult.ptgt)
                    .attr("y",relativeHeightTarget)
                    .attr("x",function(d,i){return (i*sizeClsTarget)+2*margin+5;});
                    labels.data(clustersAppeared).enter().append("text")
                    .text(function(d){return d.name;})
                    .style("font-size", "18px")
                    .attr("class", "Cluster")
                    .attr("period", objectResult.ptgt)
                    .attr("y",relativeHeightTarget)
                    .attr("x",function(d,i){return ((i + TargetList.length)*sizeClsTarget)+2*margin+5;});


                    //---------------------------------------------------------------------------Adding the edges between clusters
                    var Line = function(x1,y1, srcName,x2,y2,targetName,activity,kernel,matchingType, color){
                        this.x1 = x1;
                        this.y1 = y1;
                        this.x2 = x2;
                        this.y2 = y2;
                        this.srcName=srcName.replace(/\s/g, '');
                        this.targetName=targetName.replace(/\s/g, '');
                        this.color = color;
                        this.activity=activity;
                        this.matchingType=matchingType;
                        this.kernel=kernel;
                    };

                    logger.debug("Drawing links");
                    var lines = [];
                    for (i in SrcList) {
                        c=SrcList[i];
                        var lineColor = colors.range()[i];
                        //Pour toutes les targets
                        for(var i=0;i < c.target.length;i++){
                            var target = clustersTarget[c.target[i]];
                            lines.push(new Line(c.x, c.y,c.name, target.x, target.y,target.name, c.targetActivity[i], c.kernel[i], c.matching[i], lineColor));
                        }
                    };
                    svg.selectAll("line").data(lines).enter().append("line")
                    .style("stroke", function(d){return d.color;})
                    .style("stroke-width", "7px")
                    .style("stroke-opacity", "0.2")
                    .attr("x1",function(d){return d.x1;})
                    .attr("y1",function(d){return d.y1;})
                    .attr("x2",function(d){return d.x1;})
                    .attr("y2",function(d){return d.y1;})
                    .attr("x2",function(d){return d.x2;})
                    .attr("y2",function(d){return d.y2;})
                    .attr("src", function(d){return d.srcName.replace(/\s/g, '');})
                    .attr("target", function(d){return d.targetName.replace(/\s/g, '');})
                    .attr("matchingType", function(d){return d.matchingType;})
                    .attr("kernel", function(d){logger.debug(d.kernel); return JSON.stringify(d.kernel);});
                    svg.selectAll(".activity").data(lines).enter()
                    .append("text")
                    .attr("x", function(d){return (d.x1 + d.x2)/2 + 5;})
                    .attr("y", function(d){return (d.y1 + d.y2)/2;})
                    .attr("src", function(d){return d.srcName.replace(/\s/g, '');})
                    .attr("target", function(d){return d.targetName.replace(/\s/g, '');})
                    .attr("class", "activity")
                    .style("font-size", "18px")
                    .attr("id", function(d){return d.srcName.replace(/\s/g, '')+d.targetName.replace(/\s/g, '');})
                    .style("fill", function(d){return d.color;})
                    .style("fill-opacity", "0.2")
                    .text(function(d){var num = new Number(d.activity); return num.toFixed(2);});

                    objectResult.svgsrc = window.document.querySelector('#dataviz-container').innerHTML;
                    controller.diachronie(res, objectResult);                    
                }
            );
    }
}